<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>True Random Shuffler</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1a4d2e 0%, #000000 50%, #1a4d2e 100%);
            min-height: 100vh;
            color: white;
            padding: 20px;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        .card {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            border: 1px solid rgba(29, 185, 84, 0.2);
            margin-bottom: 20px;
        }
        
        .logo {
            text-align: center;
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        h1 {
            font-size: 32px;
            text-align: center;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #b3b3b3;
            margin-bottom: 30px;
        }
        
        button {
            width: 100%;
            background: #1db954;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #1ed760;
        }
        
        button:disabled {
            background: #535353;
            cursor: not-allowed;
        }
        
        .playlist-item {
            background: rgba(29, 185, 84, 0.1);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            cursor: pointer;
            border: 1px solid rgba(29, 185, 84, 0.2);
            transition: background 0.3s;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .playlist-item:hover {
            background: rgba(29, 185, 84, 0.2);
        }
        
        .playlist-img {
            width: 50px;
            height: 50px;
            border-radius: 5px;
        }
        
        .track-item {
            padding: 12px 0;
            border-bottom: 1px solid #333;
        }
        
        .track-name {
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .track-artist {
            color: #b3b3b3;
            font-size: 14px;
        }
        
        .now-playing {
            background: rgba(29, 185, 84, 0.1);
            padding: 20px;
            border-radius: 10px;
            border: 1px solid rgba(29, 185, 84, 0.2);
            margin-bottom: 15px;
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn-secondary {
            background: rgba(29, 185, 84, 0.2);
        }
        
        .btn-secondary:hover {
            background: rgba(29, 185, 84, 0.3);
        }
        
        .back-link {
            color: #1db954;
            text-decoration: none;
            display: inline-block;
            margin-bottom: 15px;
        }
        
        .back-link:hover {
            text-decoration: underline;
        }
        
        #playlists, #player {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Screen -->
        <div id="login">
            <div class="card">
                <div class="logo">üéµ</div>
                <h1>True Random Shuffler</h1>
                <p class="subtitle">Get truly random shuffle for your Spotify playlists</p>
                <button onclick="loginToSpotify()">Connect to Spotify</button>
            </div>
        </div>

        <!-- Playlists Screen -->
        <div id="playlists">
            <div class="card">
                <h1>Your Playlists</h1>
                <p class="subtitle">Select a playlist to shuffle</p>
                <div id="playlist-list"></div>
            </div>
        </div>

        <!-- Player Screen -->
        <div id="player">
            <div class="card">
                <a href="#" class="back-link" onclick="showPlaylists()">‚Üê Back to playlists</a>
                <h2 id="playlist-name"></h2>
                <div class="controls">
                    <button onclick="reshuffle()">üîÄ Re-shuffle</button>
                </div>
            </div>
            
            <div class="card">
                <p class="subtitle" id="track-counter"></p>
                <div class="now-playing">
                    <div class="track-name" id="current-track-name"></div>
                    <div class="track-artist" id="current-track-artist"></div>
                </div>
                <div class="controls">
                    <button onclick="playCurrentTrack()">‚ñ∂ Play</button>
                    <button class="btn-secondary" onclick="playNext()">‚è≠ Next</button>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-bottom: 15px;">Queue</h3>
                <div id="queue"></div>
            </div>
        </div>
    </div>

    <script>
        // REPLACE WITH YOUR CLIENT ID
        const CLIENT_ID = '5dbf24359e504094985647fc4e2d8951';
        const REDIRECT_URI = 'https://waiterplane.github.io/shuffler/';
        const SCOPES = 'user-read-private playlist-read-private user-modify-playback-state';

        let token = '';
        let playlists = [];
        let currentPlaylist = null;
        let shuffledTracks = [];
        let currentIndex = 0;

        // Check for token in URL
        window.addEventListener('load', () => {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');
            
            if (accessToken) {
                token = accessToken;
                window.location.hash = '';
                loadPlaylists();
            }
        });

        function loginToSpotify() {
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPES)}`;
            window.location.href = authUrl;
        }

        async function loadPlaylists() {
            document.getElementById('login').style.display = 'none';
            document.getElementById('playlists').style.display = 'block';
            
            const response = await fetch('https://api.spotify.com/v1/me/playlists?limit=50', {
                headers: { 'Authorization': `Bearer ${token}` }
            });
            const data = await response.json();
            playlists = data.items;
            
            const listEl = document.getElementById('playlist-list');
            listEl.innerHTML = playlists.map(p => `
                <div class="playlist-item" onclick="selectPlaylist('${p.id}')">
                    ${p.images[0] ? `<img src="${p.images[0].url}" class="playlist-img">` : ''}
                    <div>
                        <div class="track-name">${p.name}</div>
                        <div class="track-artist">${p.tracks.total} tracks</div>
                    </div>
                </div>
            `).join('');
        }

        async function selectPlaylist(playlistId) {
            currentPlaylist = playlists.find(p => p.id === playlistId);
            
            // Fetch all tracks
            let allTracks = [];
            let url = `https://api.spotify.com/v1/playlists/${playlistId}/tracks`;
            
            while (url) {
                const response = await fetch(url, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                allTracks = [...allTracks, ...data.items.filter(item => item.track)];
                url = data.next;
            }
            
            shuffledTracks = trulyRandomShuffle(allTracks.map(item => item.track));
            currentIndex = 0;
            
            showPlayer();
        }

        function trulyRandomShuffle(array) {
            const shuffled = [...array];
            const randomValues = new Uint32Array(shuffled.length);
            crypto.getRandomValues(randomValues);
            
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = randomValues[i] % (i + 1);
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            
            return shuffled;
        }

        function showPlayer() {
            document.getElementById('playlists').style.display = 'none';
            document.getElementById('player').style.display = 'block';
            
            document.getElementById('playlist-name').textContent = currentPlaylist.name;
            updatePlayerDisplay();
        }

        function showPlaylists() {
            document.getElementById('player').style.display = 'none';
            document.getElementById('playlists').style.display = 'block';
        }

        function updatePlayerDisplay() {
            const track = shuffledTracks[currentIndex];
            document.getElementById('track-counter').textContent = `Now Playing (${currentIndex + 1}/${shuffledTracks.length})`;
            document.getElementById('current-track-name').textContent = track.name;
            document.getElementById('current-track-artist').textContent = track.artists.map(a => a.name).join(', ');
            
            const queueEl = document.getElementById('queue');
            const queueTracks = shuffledTracks.slice(currentIndex + 1, currentIndex + 11);
            queueEl.innerHTML = queueTracks.map(t => `
                <div class="track-item">
                    <div class="track-name">${t.name}</div>
                    <div class="track-artist">${t.artists.map(a => a.name).join(', ')}</div>
                </div>
            `).join('');
        }

        async function playCurrentTrack() {
            const track = shuffledTracks[currentIndex];
            try {
                await fetch('https://api.spotify.com/v1/me/player/play', {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ uris: [track.uri] })
                });
            } catch (error) {
                alert('Make sure Spotify is open on a device and try again');
            }
        }

        function playNext() {
            if (currentIndex < shuffledTracks.length - 1) {
                currentIndex++;
                updatePlayerDisplay();
                playCurrentTrack();
            }
        }

        function reshuffle() {
            shuffledTracks = trulyRandomShuffle(shuffledTracks);
            currentIndex = 0;
            updatePlayerDisplay();
        }
    </script>
</body>
</html>
